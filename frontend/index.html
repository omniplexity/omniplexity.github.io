<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>OmniAI</title>
    <link rel="stylesheet" href="assets/css/style.css?t=1737500000">
</head>
<body>
    <div id="app" data-page="chat">
        <!-- Login View -->
        <div id="login-view" class="view auth-view hidden">
            <div class="auth-container">
                <div class="auth-logo">OmniAI</div>
                <h1>Welcome back</h1>
                <p class="auth-subtitle">Sign in to continue your conversations</p>
                <form id="login-form">
                    <div class="form-group">
                        <label for="username">Username</label>
                        <input type="text" id="username" placeholder="Enter your username" required aria-label="Username">
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" placeholder="Enter your password" required aria-label="Password">
                    </div>
                    <button type="submit" class="btn-primary btn-full">Sign In</button>
                </form>
                <div id="login-error" class="error-message hidden"></div>
                <p class="auth-switch">Don't have an account? <a href="#" id="show-register">Register</a></p>
            </div>
        </div>

        <!-- Register View -->
        <div id="register-view" class="view auth-view hidden">
            <div class="auth-container">
                <div class="auth-logo">OmniAI</div>
                <h1>Create account</h1>
                <p class="auth-subtitle">Get started with an invite code</p>
                <form id="register-form">
                    <div class="form-group">
                        <label for="invite-code">Invite Code</label>
                        <input type="text" id="invite-code" placeholder="Enter your invite code" required aria-label="Invite Code">
                    </div>
                    <div class="form-group">
                        <label for="reg-username">Username</label>
                        <input type="text" id="reg-username" placeholder="Choose a username" required aria-label="Username">
                    </div>
                    <div class="form-group">
                        <label for="reg-password">Password</label>
                        <input type="password" id="reg-password" placeholder="Create a password" required aria-label="Password">
                    </div>
                    <button type="submit" class="btn-primary btn-full">Create Account</button>
                </form>
                <div id="register-error" class="error-message hidden"></div>
                <p class="auth-switch">Already have an account? <a href="#" id="show-login">Sign in</a></p>
            </div>
        </div>

        <!-- Setup View (Backend Configuration) -->
        <div id="setup-view" class="view auth-view hidden">
            <div class="auth-container">
                <div class="auth-logo">OmniAI</div>
                <h1>Connect to Backend</h1>
                <p class="auth-subtitle">Enter your backend server URL to get started</p>
                <form id="setup-form">
                    <div class="form-group">
                        <label for="setup-backend-url">Backend URL</label>
                        <input type="url" id="setup-backend-url" placeholder="https://rossie-chargeful-plentifully.ngrok-free.dev" required aria-label="Backend URL">
                        <span class="setting-hint">Your Cloudflare Tunnel or ngrok URL</span>
                    </div>
                    <button type="submit" class="btn-primary btn-full">Connect</button>
                </form>
                <div id="setup-error" class="error-message hidden"></div>
                <div class="setup-help">
                    <h3>Need help?</h3>
                    <p>OmniAI requires a backend server running on your local machine, exposed via a tunnel service.</p>
                    <ol>
                        <li>Start the backend: <code>python backend/devserver.py</code></li>
                        <li>Expose it with Cloudflare Tunnel or ngrok</li>
                        <li>Enter the tunnel URL above</li>
                    </ol>
                </div>
            </div>
        </div>

        <!-- Chat View -->
        <div id="chat-view" class="view">
            <!-- Mobile Sidebar Toggle -->
            <button id="sidebar-toggle" class="sidebar-toggle" aria-label="Toggle sidebar" aria-expanded="false">
                <span class="hamburger-icon"></span>
            </button>

            <!-- Sidebar Backdrop (mobile) -->
            <div id="sidebar-backdrop" class="sidebar-backdrop hidden"></div>

            <!-- Sidebar -->
            <aside id="sidebar" role="navigation" aria-label="Conversations">
                <div id="sidebar-header">
                    <button id="new-conversation-btn" class="btn-new-chat" aria-label="New conversation">
                        <span class="icon-plus">+</span>
                        <span>New Chat</span>
                    </button>
                </div>
                <div id="sidebar-search">
                    <input type="text" id="search-conversations" placeholder="Search conversations..." aria-label="Search conversations">
                </div>
                <ul id="conversations-list" role="list" aria-label="Conversation threads"></ul>
                <div id="sidebar-footer">
                    <button id="settings-toggle-btn" class="sidebar-footer-btn" aria-label="Settings">
                        <span class="icon-settings"></span>
                        <span>Settings</span>
                    </button>
                    <div id="sidebar-user-info">
                        <span id="sidebar-user-display"></span>
                        <button id="sidebar-logout-btn" class="sidebar-footer-btn" aria-label="Logout">
                            <span class="icon-logout"></span>
                            <span>Log out</span>
                        </button>
                    </div>
                </div>
            </aside>

            <!-- Main Content -->
            <div id="chat-content">
                <!-- Topbar -->
                <header id="topbar">
                    <div id="topbar-left">
                        <span id="logo">OmniAI</span>
                    </div>
                    <div id="topbar-center">
                        <h1 id="chat-title" class="topbar-title">New Chat</h1>
                    </div>
                    <div id="topbar-right">
                        <div id="model-picker">
                            <select id="provider-select" aria-label="Provider">
                                <option value="">Provider</option>
                            </select>
                            <select id="model-select" aria-label="Model" disabled>
                                <option value="">Model</option>
                            </select>
                        </div>
                        <div id="connection-status">
                            <span id="connection-indicator" class="status-indicator"></span>
                            <span id="connection-text">Offline</span>
                        </div>
                        <button id="controls-btn" class="topbar-btn" aria-label="Generation controls" title="Generation settings">
                            <span class="icon-sliders"></span>
                        </button>
                        <div id="user-menu">
                            <span id="user-display"></span>
                            <a href="#admin" id="admin-link" class="hidden" aria-label="Admin panel">Admin</a>
                            <button id="logout-btn" class="topbar-btn" aria-label="Logout" title="Log out">
                                <span class="icon-logout"></span>
                            </button>
                        </div>
                    </div>
                </header>

                <!-- Main Chat Area -->
                <main id="main">
                    <!-- Chat Header Actions -->
                    <div id="chat-header-actions" class="hidden">
                        <button id="rename-chat-btn" class="btn-ghost" aria-label="Rename conversation">Rename</button>
                        <button id="delete-chat-btn" class="btn-ghost btn-danger" aria-label="Delete conversation">Delete</button>
                    </div>

                    <!-- Transcript -->
                    <div id="transcript" role="log" aria-live="polite" aria-label="Chat transcript">
                        <div id="empty-state" class="empty-state">
                            <h2>How can I help?</h2>
                            <div class="suggestion-grid">
                                <button class="suggestion-btn" data-prompt="Explain quantum computing in simple terms">
                                    Explain quantum computing
                                </button>
                                <button class="suggestion-btn" data-prompt="Write a Python function to sort a list">
                                    Write a Python function
                                </button>
                                <button class="suggestion-btn" data-prompt="Debug this code and explain the issues">
                                    Debug my code
                                </button>
                                <button class="suggestion-btn" data-prompt="Help me plan a new software project">
                                    Plan a project
                                </button>
                                <button class="suggestion-btn" data-prompt="Analyze these data trends and provide insights">
                                    Analyze data trends
                                </button>
                                <button class="suggestion-btn" data-prompt="Help me design a REST API for my application">
                                    Design an API
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Jump to Latest Pill -->
                    <button id="jump-to-latest" class="jump-pill hidden" aria-label="Jump to latest message">
                        <span class="icon-arrow-down"></span>
                        Jump to latest
                    </button>

                    <!-- Composer -->
                    <div id="composer">
                        <div id="input-wrapper">
                            <textarea id="message-input" placeholder="Type your message..." aria-label="Message input" rows="1"></textarea>
                            <div id="composer-actions">
                                <button id="send-btn" class="send-btn" disabled aria-label="Send message" title="Send message">
                                    Send
                                </button>
                                <button id="cancel-btn" class="cancel-btn hidden" aria-label="Stop generating" title="Stop generating">
                                    Stop
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Status Line -->
                    <div id="status-line">
                        <span id="status-text">Ready</span>
                        <span id="elapsed-time"></span>
                        <span id="token-usage"></span>
                    </div>
                </main>
            </div>

            <!-- Settings Drawer -->
            <div id="settingsDrawer" class="settings-drawer hidden" role="dialog" aria-labelledby="settings-title" aria-modal="true">
                <div id="settings-header">
                    <h2 id="settings-title">Settings</h2>
                    <button id="close-settings-btn" class="btn-close" aria-label="Close settings">&times;</button>
                </div>
                <div id="settings-content">
                    <!-- Generation Settings -->
                    <section id="run-settings" class="settings-section">
                        <h3>Generation Settings</h3>
                        <div class="setting-group">
                            <label for="drawer-temperature">
                                Temperature
                                <span class="setting-hint">Controls randomness (0 = deterministic, 2 = creative)</span>
                            </label>
                            <div class="setting-input-row">
                                <input type="range" id="drawer-temperature-range" min="0" max="2" step="0.1" value="0.7">
                                <input type="number" id="drawer-temperature" min="0" max="2" step="0.1" value="0.7">
                            </div>
                        </div>
                        <div class="setting-group">
                            <label for="drawer-top-p">
                                Top-P
                                <span class="setting-hint">Nucleus sampling threshold</span>
                            </label>
                            <div class="setting-input-row">
                                <input type="range" id="drawer-top-p-range" min="0" max="1" step="0.01" value="1">
                                <input type="number" id="drawer-top-p" min="0" max="1" step="0.01" value="1">
                            </div>
                        </div>
                        <div class="setting-group">
                            <label for="drawer-max-tokens">
                                Max Tokens
                                <span class="setting-hint">Maximum response length</span>
                            </label>
                            <input type="number" id="drawer-max-tokens" min="1" max="128000" step="1" placeholder="No limit">
                        </div>
                    </section>

                    <!-- Presets -->
                    <section id="presets" class="settings-section">
                        <h3>Presets</h3>
                        <select id="preset-select" aria-label="Select preset">
                            <option value="">Select Preset</option>
                        </select>
                        <div class="preset-actions">
                            <button id="save-preset-btn" class="btn-secondary">Save Current</button>
                            <button id="delete-preset-btn" class="btn-ghost btn-danger">Delete</button>
                        </div>
                    </section>

                    <!-- Prompt Templates -->
                    <section id="prompt-dock" class="settings-section">
                        <h3>Prompt Templates</h3>
                        <div id="prompt-templates" class="prompt-chips"></div>
                        <h4>Saved Prompts</h4>
                        <div id="saved-prompts">
                            <div class="saved-prompt-controls">
                                <input type="text" id="new-prompt-name" placeholder="Prompt name" maxlength="50">
                                <button id="save-prompt-btn" class="btn-secondary">Save Current</button>
                            </div>
                            <div id="saved-prompts-list" class="saved-prompts-list"></div>
                        </div>
                    </section>

                    <!-- Backend Configuration -->
                    <section id="backend-settings" class="settings-section">
                        <h3>Backend</h3>
                        <div class="setting-group">
                            <label for="api-base-url">API Base URL</label>
                            <div class="setting-input-row">
                                <input type="url" id="api-base-url" placeholder="https://...">
                                <button id="save-url-btn" class="btn-secondary">Save</button>
                            </div>
                        </div>
                    </section>
                </div>
            </div>

            <!-- Controls Panel (Quick Settings) -->
            <div id="controls-panel" class="controls-panel hidden" role="dialog" aria-label="Quick generation settings">
                <div class="controls-panel-content">
                    <div class="control-group">
                        <label>Temp: <span id="temp-display">0.7</span></label>
                        <input type="range" id="quick-temperature" min="0" max="2" step="0.1" value="0.7">
                    </div>
                    <div class="control-group">
                        <label>Top-P: <span id="top-p-display">1.0</span></label>
                        <input type="range" id="quick-top-p" min="0" max="1" step="0.05" value="1">
                    </div>
                    <div class="control-group">
                        <label>Max Tokens</label>
                        <input type="number" id="quick-max-tokens" min="1" placeholder="No limit">
                    </div>
                </div>
            </div>

            <!-- Toast Container -->
            <div id="toastHost" aria-live="assertive" aria-atomic="true"></div>

            <!-- Modal Host -->
            <div id="modalHost"></div>
        </div>

        <!-- Admin View -->
        <div id="admin-view" class="view hidden">
            <header id="admin-header">
                <div id="admin-brand">
                    <a href="#chat" class="admin-back-link">&larr; Back to Chat</a>
                    <span class="admin-title">Admin Panel</span>
                </div>
                <div id="admin-user-info">
                    <span id="admin-user-display"></span>
                    <button id="admin-logout-btn" class="btn-ghost">Logout</button>
                </div>
            </header>

            <div id="admin-container">
                <nav id="admin-nav" role="tablist">
                    <button id="admin-users-tab" class="admin-tab active" role="tab" aria-selected="true">Users</button>
                    <button id="admin-invites-tab" class="admin-tab" role="tab" aria-selected="false">Invites</button>
                    <button id="admin-audit-tab" class="admin-tab" role="tab" aria-selected="false">Audit Log</button>
                    <button id="admin-quotas-tab" class="admin-tab" role="tab" aria-selected="false">Quotas</button>
                </nav>

                <main id="admin-main">
                    <div id="admin-users-section" class="admin-section" role="tabpanel">
                        <h2>Users</h2>
                        <table id="users-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Username</th>
                                    <th>Display Name</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th>Last Login</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-tbody"></tbody>
                        </table>
                    </div>

                    <div id="admin-invites-section" class="admin-section hidden" role="tabpanel">
                        <h2>Invites</h2>
                        <button id="create-invite-btn" class="btn-primary">Create Invite</button>
                        <table id="invites-table">
                            <thead>
                                <tr>
                                    <th>Code</th>
                                    <th>Created By</th>
                                    <th>Used By</th>
                                    <th>Expires</th>
                                    <th>Revoked</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="invites-tbody"></tbody>
                        </table>
                    </div>

                    <div id="admin-audit-section" class="admin-section hidden" role="tabpanel">
                        <h2>Audit Log</h2>
                        <div id="audit-filters">
                            <input type="text" id="audit-q" placeholder="Search target...">
                            <select id="audit-action">
                                <option value="">All Actions</option>
                            </select>
                            <input type="datetime-local" id="audit-since">
                            <button id="audit-search-btn" class="btn-primary">Search</button>
                        </div>
                        <table id="audit-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Action</th>
                                    <th>Target</th>
                                    <th>Actor</th>
                                    <th>IP</th>
                                    <th>Time</th>
                                </tr>
                            </thead>
                            <tbody id="audit-tbody"></tbody>
                        </table>
                    </div>

                    <div id="admin-quotas-section" class="admin-section hidden" role="tabpanel">
                        <h2>User Quotas</h2>
                        <table id="quotas-table">
                            <thead>
                                <tr>
                                    <th>User ID</th>
                                    <th>Username</th>
                                    <th>Messages/Day</th>
                                    <th>Tokens/Day</th>
                                    <th>Updated</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="quotas-tbody"></tbody>
                        </table>
                    </div>
                </main>
            </div>
        </div>

        <!-- Global Banners -->
        <div id="error-banner" class="banner banner-error hidden">
            <span id="error-message"></span>
            <button id="dismiss-error" class="btn-close" aria-label="Dismiss">&times;</button>
        </div>

        <div id="disconnect-banner" class="banner banner-warning hidden">
            <span>Disconnected from server.</span>
            <button id="retry-stream" class="btn-secondary">Retry</button>
        </div>
    </div>

    <script src="js/config.js?t=1737500000"></script>
    <script src="js/api.js?t=1737500000"></script>
    <script src="js/auth.js?t=1737500000"></script>
    <script src="js/sse.js?t=1737500000"></script>
    <script src="js/store.js?t=1737500000"></script>
    <script src="js/render.js?t=1737500000"></script>
    <script src="js/admin.js?t=1737500000"></script>
    <script src="js/command-palette.js?t=1737500000"></script>
    <script src="js/prompt-dock.js?t=1737500000"></script>
    <script src="js/app.js?t=1737500000" defer></script>
</body>
</html>