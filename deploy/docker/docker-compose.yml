# OmniAI Docker Compose - Backend only (Phase 1)
# Usage:
#   1) cp .env.example .env
#   2) docker compose --profile ngrok up -d --build

services:
  api:
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile.backend
    container_name: omniai-api
    env_file:
      - .env
    volumes:
      - data:/data
      - uploads:/uploads

  cloudflared:
    image: cloudflare/cloudflared:latest
    depends_on:
      - api
    restart: unless-stopped
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
    command: ["tunnel","--no-autoupdate","run","--token","${CLOUDFLARE_TUNNEL_TOKEN}"]
    profiles: ["tunnel"]

  ngrok:
    image: ngrok/ngrok:alpine
    depends_on:
      - api
    restart: unless-stopped
    volumes:
      - ./ngrok.yml:/etc/ngrok.yml:ro
    environment:
      - NGROK_CONFIG=/etc/ngrok.yml
    command: ["start","--all","--config","/etc/ngrok.yml"]
    profiles: ["ngrok"]

  # postgres:
  #   image: postgres:16
  #   environment:
  #     POSTGRES_DB: omniai
  #     POSTGRES_USER: omniai
  #     POSTGRES_PASSWORD: change_me
  #   volumes:
  #     - postgres_data:/var/lib/postgresql/data
  #   ports:
  #     - "5432:5432"

volumes:
  data:
  uploads:
  # postgres_data:
